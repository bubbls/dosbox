<!DOCTYPE html>
<html lang="en">

<meta http-equiv="content-type" content="text/html;charset=UTF-8" />

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Daggerfall</title>
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            background: black;
            color: #fedb1d;
            overflow: hidden;
        }
        
        #canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            width: auto;
            height: 100%;
            background: black;
            padding: 0;
            margin: 0;
            -webkit-transform: translate(-50%, -50%);
            -moz-transform: translate(-50%, -50%);
            -ms-transform: translate(-50%, -50%);
            -o-transform: translate(-50%, -50%);
            transform: translate(-50%, -50%);
        }
        
        .emularity-splash-screen {
            text-align: center;
            position: absolute;
            left: 0;
            right: 0;
            bottom: 50%;
            margin: 0;
            box-sizing: border-box;
            color: #000;
        }
        
        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            font-family: monospace;
            font-size: 20px;
        }
        
        #progress {
            margin-top: 20px;
            font-size: 16px;
        }
    </style>
</head>

<body>
    <div id="loading">
        <div>Loading Daggerfall...</div>
        <div id="progress">Merging archive parts: 0%</div>
    </div>
    <canvas id="canvas" style="width: 50%; height: 50%; display: none; margin: 0 auto;" onClick="window.focus();" />
    <script type="text/javascript" src="js/es6-promise.js"></script>
    <script type="text/javascript" src="js/browserfs.min.js"></script>
    <script type="text/javascript" src="js/loader.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>

    <script type="text/javascript">
        const PARTS_FOLDER = 'softs/daggerfall/';
        const BASE_FILENAME = 'Daggerfall.zip';
        const NUM_PARTS = 8;
        const GAME_EXE = 'DAGGER.EXE';  
        const GAME_PATH = 'DAGGERF~1';  

        async function loadAndMergeZipParts() {
            const progressEl = document.getElementById('progress');
            const loadingEl = document.getElementById('loading');
            
            try {
                const chunks = [];
                
                progressEl.textContent = 'Detecting file format...';
                let useZeroPadding = false;
                
                const testUrl01 = `${PARTS_FOLDER}${BASE_FILENAME}.part01`;
                const test01 = await fetch(testUrl01, { method: 'HEAD' });
                
                if (test01.ok) {
                    useZeroPadding = true;
                    console.log('Using zero-padded format (.part01, .part02, etc.)');
                } else {
                    const testUrl1 = `${PARTS_FOLDER}${BASE_FILENAME}.part1`;
                    const test1 = await fetch(testUrl1, { method: 'HEAD' });
                    
                    if (test1.ok) {
                        useZeroPadding = false;
                        console.log('Using non-padded format (.part1, .part2, etc.)');
                    } else {
                        throw new Error('Could not find part files. Checked for both .part01 and .part1 formats.');
                    }
                }
                
                for (let i = 1; i <= NUM_PARTS; i++) {
                    progressEl.textContent = `Loading part ${i}/${NUM_PARTS}...`;
                    
                    const partNum = useZeroPadding ? i.toString().padStart(2, '0') : i.toString();
                    const partUrl = `${PARTS_FOLDER}${BASE_FILENAME}.part${partNum}`;
                    const response = await fetch(partUrl);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load ${partUrl}: ${response.status}`);
                    }
                    
                    const arrayBuffer = await response.arrayBuffer();
                    chunks.push(arrayBuffer);
                    
                    const progress = Math.round((i / NUM_PARTS) * 100);
                    progressEl.textContent = `Merging archive parts: ${progress}%`;
                }
                
                progressEl.textContent = 'Merging complete! Starting emulator...';
                const mergedBlob = new Blob(chunks, { type: 'application/zip' });
                
                window.lastMergedSize = mergedBlob.size;
                console.log('Merged blob created:', mergedBlob.size, 'bytes');
                
                const blobUrl = URL.createObjectURL(mergedBlob);
                
                loadingEl.style.display = 'none';
                document.getElementById('canvas').style.display = 'block';
                
                startEmulator(blobUrl);
                
            } catch (error) {
                progressEl.textContent = `Error: ${error.message}`;
                console.error('Failed to load game:', error);
            }
        }

        function startEmulator(blobUrl) {
            const exePath = 'C:\\DAGGERF~1\\dagger.bat';
            
            var dosbox = new Emulator(document.querySelector("#canvas"),
                null,
                new DosBoxLoader(DosBoxLoader.emulatorJS("js/dosbox-sync.js"),
                    DosBoxLoader.locateAdditionalEmulatorJS(locateAdditionalFiles),
                    DosBoxLoader.nativeResolution(640, 400),
                    DosBoxLoader.mountZip("c",
                        DosBoxLoader.fetchFile("Software", blobUrl)),
                    DosBoxLoader.startExe(exePath)));
            dosbox.start({
                waitAfterDownloading: true
            });
            
            console.log('Emulator started with blob URL:', blobUrl);
            console.log('Blob size:', window.lastMergedSize, 'bytes');
            console.log('Executing:', exePath);

            function locateAdditionalFiles(filename) {
                if (filename === "dosbox.html.mem") {
                    return "js/dosbox-sync.mem";
                }
                return "js/" + filename;
            }
        }

        window.addEventListener('load', loadAndMergeZipParts);
    </script>
</body>

</html>